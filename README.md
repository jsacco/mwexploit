# Exploit Title: MalwareBytes v19 Arbitrary File Deletion leads to Privilege Escalation
# Author: Juan Sacco <jsacco@exploitpack.com> - https://exploitpack.com
# Date: 12/08/2024
# Video link: https://www.youtube.com/watch?v=VptBB3GYz1s
# Vendor homepage: https://www.malwarebytes.com/
# Tested on: Windows 10 Pro
# Affected version v19 and prior

# Description: Malwarebytes is prone to an arbitrary file deletion (usage of DeleteFileW by MBAMService.exe) running as SYSTEM, this process can be manipulated from a non-admin user because it fails to properly filter the user supplied input while scanning a file, this vulnerability leads to a privilege escalation. This exploit was tested on Windows 10 Pro version 22H2 (OS Build 19045.4412)
Vulnerable versions: Malwarebytes version 5.1.6.177 Update Package version 1.0.87118 Component Package version 1.0.1280
Description: A non-admin use could abuse this vulnerability to remove local system files, disable or corrupt other processes and/or escalate privileges to System.
Mitigation On Windows, standard users have write permissions to the following folders, and these permissions might cascade to subfolders due to inheritance, software developers should also consider enabling the ProcessRedirectionTrustPolicy mitigation policy in their Windows processes to have them verify a junctionâ€™s trust level. Microsoft introduced this mitigation policy to prevent high-integrity processes, such as those from NT AUTHORITY\SYSTEM, from processing junctions created by non-administrator users.
C:\Windows\Temp C:\ProgramData C:\Users\XXXX* C:\ (ability to create folders)

# Steps To Reproduce and exploit code:
Run a CMD.exe and type winver, make sure the version is: Windows 10 Pro version 22H2 as this exploit was tested on this Windows version.
Open Malwarebytes and go to About, make sure the version is 5.1.6.177, as this exploit was tested on this version.
Run the exploit script: MWExploit.bat
Right click on any file and select "Scan with Malwarebytes"
Open the On-Screen Keyboard (HID.dll) and a SYSTEM shell will spawn

Supporting Material/References:
https://www.zerodayinitiative.com/blog/2022/3/16/abusing-arbitrary-file-deletes-to-escalate-privilege-and-other-great-tricks

# Impact:
As per the same user-space and permissions rights of the affected process (MBAMService.exe runs as SYSTEM) a non-admin use could abuse this vulnerability to manipulate the behavior of the process and arbitrarily force the removal of local system files, disable or corrupt other processes and/or escalate privileges to System.
